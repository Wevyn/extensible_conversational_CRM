{"ast":null,"code":"// advanced-parser.js - Enhanced AI parsing for deal intelligence\n\nimport { isTeamOrRole, analyzeDealLanguage, mapToValidStage } from './advanced-attio.js';\nexport async function sendToAdvancedDeepSeek(text, conversationContext = {}) {\n  const dealAnalysis = analyzeDealLanguage(text);\n  const prompt = `\nYou are an advanced Attio CRM intelligence assistant. Extract structured data from sales conversations with sophisticated deal and relationship insights.\n\nCONTEXT:\n- Current conversation deals with: ${conversationContext.activeDeals || 'unknown deals'}\n- Known contacts: ${conversationContext.knownContacts || 'unknown contacts'}  \n- Company focus: ${conversationContext.company || 'unknown company'}\n\nCRITICAL EXTRACTION RULES:\n1. âŒ DO NOT create person objects for teams, roles, or departments:\n   - Skip: \"Engineering Team\", \"Legal Team\", \"Marketing Team\", \"CTO\", \"CEO\", \"VP Sales\"\n   - Instead: Add team/role info to individual person's notes or role field\n2. âœ… DO create person objects only for named individuals:\n   - \"Lisa from marketing\" âœ…\n   - \"Dave in procurement\" âœ…  \n   - \"Engineering Team\" âŒ\n3. ðŸ”„ For updating existing people, always include identifying info (email preferred)\n4. ðŸŽ¯ Use ONLY these valid deal stages (case sensitive):\n   - \"Qualified\", \"Discovery\", \"Demo\", \"Proposal\", \"Negotiation\", \"Closed Won\", \"Closed Lost\"\n5. ðŸ”— Link deals to companies and decision makers when possible\n6. ðŸ“‹ Create follow-up tasks for implied next steps\n7. ðŸ’¼ Support employee-employee CRM with internal stakeholder tracking\n\nIMPORTANT: Use these valid deal stages only:\n- \"Qualified\" (for initial contact, first calls)\n- \"Discovery\" (for requirement gathering, understanding needs)\n- \"Demo\" (for demonstrations, presentations)\n- \"Proposal\" (for quotes, pricing, proposals)\n- \"Negotiation\" (for contract terms, legal review)\n- \"Closed Won\" (for signed deals)\n- \"Closed Lost\" (for lost deals)\n\nRESPONSE FORMAT - Return valid JSON array with these object types:\n\nPERSON OBJECT:\n{\n  \"type\": \"person\",\n  \"name\": \"Full Name\",\n  \"first_name\": \"First\",\n  \"last_name\": \"Last\",\n  \"email\": \"email@domain.com\",\n  \"role\": \"CTO/CMO/etc\",\n  \"company\": \"Company Name\",\n  \"sentiment\": \"positive/negative/neutral\",\n  \"notes\": \"Context about this person's stance/concerns\"\n}\n\nCOMPANY OBJECT:\n{\n  \"type\": \"company\", \n  \"name\": \"Company Name\",\n  \"relationship_health\": \"high/medium/low\",\n  \"expansion_opportunity\": \"Description of expansion potential\",\n  \"churn_risk\": \"low/medium/high\"\n}\n\nDEAL OBJECT:\n{\n  \"type\": \"deal\",\n  \"name\": \"Deal Name\",\n  \"company\": \"Company Name\", \n  \"value\": 150000,\n  \"close_date\": \"Q1 2026\",\n  \"stage\": \"Proposal\",\n  \"probability\": 75,\n  \"competitors\": [\"Competitor 1\", \"Competitor 2\"],\n  \"pain_points\": [\"Integration concerns\", \"Budget constraints\"],\n  \"decision_maker\": \"Person Name\",\n  \"buying_signals\": [\"budget approved\", \"timeline established\"],\n  \"risk_signals\": [\"legal reviewing\", \"other priorities\"]\n}\n\nTASK OBJECT:\n{\n  \"type\": \"task\",\n  \"name\": \"Task Name\",\n  \"description\": \"Detailed task description\",\n  \"due_date\": \"2025-08-06T15:00:00Z\",\n  \"priority\": \"high/medium/low\",\n  \"link_to_person_name\": \"Person Name\",\n  \"link_to_company\": \"Company Name\", \n  \"link_to_deal\": \"Deal Name\",\n  \"task_type\": \"follow_up/demo/proposal/contract_review\"\n}\n\nRELATIONSHIP OBJECT:\n{\n  \"type\": \"relationship\",\n  \"company\": \"Company Name\",\n  \"contact_updates\": [\n    {\n      \"name\": \"Person Name\",\n      \"sentiment\": \"positive/negative\", \n      \"context\": \"Specific feedback or concerns\"\n    }\n  ],\n  \"account_health\": {\n    \"overall_score\": \"high/medium/low\",\n    \"expansion_notes\": \"Technical team interested in API features\",\n    \"risk_level\": \"Budget concerns from procurement\"\n  }\n}\n\nINTELLIGENCE EXTRACTION EXAMPLES:\n\nINPUT: \"So if I understand correctly, you've got budget approved for Q1 of next year, somewhere in the $150K range, but the real decision maker here is going to be your CTO because of the ERP integration concerns...\"\n\nOUTPUT:\n[\n  {\n    \"type\": \"deal\",\n    \"name\": \"Q1 2026 Deal\",\n    \"value\": 150000,\n    \"close_date\": \"Q1 2026\", \n    \"stage\": \"Proposal\",\n    \"probability\": 80,\n    \"pain_points\": [\"ERP integration concerns\"],\n    \"decision_maker\": \"CTO\",\n    \"buying_signals\": [\"budget approved\"]\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"CTO\",\n    \"first_name\": \"CTO\",\n    \"last_name\": \"\",\n    \"role\": \"CTO\", \n    \"sentiment\": \"neutral\",\n    \"notes\": \"Key decision maker, concerned about ERP integration\"\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Technical Demo for CTO\",\n    \"description\": \"Schedule technical demonstration focusing on ERP integration capabilities\",\n    \"due_date\": \"2025-08-14T15:00:00Z\",\n    \"priority\": \"high\",\n    \"link_to_person_name\": \"CTO\",\n    \"link_to_deal\": \"Q1 2026 Deal\",\n    \"task_type\": \"demo\"\n  }\n]\n\nINPUT: \"Things are going really well with the engineering team - they love the new API. But I'm a bit worried about the marketing team adoption. Lisa mentioned budget concerns for next year, and honestly, I think Dave from procurement is still skeptical about the ROI since that Q3 incident.\"\n\nOUTPUT:\n[\n  {\n    \"type\": \"company\",\n    \"name\": \"Current Client\",\n    \"relationship_health\": \"medium\",\n    \"expansion_opportunity\": \"Engineering team loves API - potential for expanded features\",\n    \"churn_risk\": \"medium\"\n  },\n  {\n    \"type\": \"person\", \n    \"name\": \"Engineering Team\",\n    \"first_name\": \"Engineering\",\n    \"last_name\": \"Team\",\n    \"role\": \"Engineering\",\n    \"sentiment\": \"positive\",\n    \"notes\": \"Loves the new API functionality\"\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"Lisa\",\n    \"first_name\": \"Lisa\",\n    \"last_name\": \"\",\n    \"role\": \"Marketing\",\n    \"sentiment\": \"negative\", \n    \"notes\": \"Has budget concerns for next year\"\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"Dave\",\n    \"first_name\": \"Dave\",\n    \"last_name\": \"\",\n    \"role\": \"Procurement\",\n    \"sentiment\": \"negative\",\n    \"notes\": \"Skeptical about ROI since Q3 incident\"\n  },\n  {\n    \"type\": \"relationship\",\n    \"company\": \"Current Client\",\n    \"contact_updates\": [\n      {\n        \"name\": \"Engineering Team\",\n        \"sentiment\": \"positive\",\n        \"context\": \"Loves new API\"\n      },\n      {\n        \"name\": \"Lisa\", \n        \"sentiment\": \"negative\",\n        \"context\": \"Budget concerns for next year\"\n      },\n      {\n        \"name\": \"Dave\",\n        \"sentiment\": \"negative\", \n        \"context\": \"Skeptical about ROI since Q3 incident\"\n      }\n    ],\n    \"account_health\": {\n      \"overall_score\": \"medium\",\n      \"expansion_notes\": \"API adoption going well with engineering\",\n      \"risk_level\": \"Budget and ROI concerns from marketing and procurement\"\n    }\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Address procurement ROI concerns with Dave\",\n    \"description\": \"Schedule meeting with Dave to address ROI skepticism stemming from Q3 incident\",\n    \"due_date\": \"2025-08-06T15:00:00Z\",\n    \"priority\": \"high\",\n    \"link_to_person_name\": \"Dave\", \n    \"link_to_company\": \"Current Client\",\n    \"task_type\": \"follow_up\"\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Explore expanded API features with engineering\",\n    \"description\": \"Follow up with engineering team on additional API features they'd find valuable\",\n    \"due_date\": \"2025-08-08T15:00:00Z\", \n    \"priority\": \"medium\",\n    \"link_to_person_name\": \"Engineering Team\",\n    \"link_to_company\": \"Current Client\",\n    \"task_type\": \"follow_up\"\n  }\n]\n\nCONVERSATION TO ANALYZE:\n\"\"\"\n${text}\n\"\"\"\n\nDETECTED SIGNALS FROM PRE-ANALYSIS:\n- Stage: ${dealAnalysis.stage}\n- Sentiment: ${dealAnalysis.sentiment} \n- Buying Signals: ${dealAnalysis.buying_signals.join(', ')}\n- Risk Signals: ${dealAnalysis.risk_signals.join(', ')}\n- Value Indicators: ${dealAnalysis.value_indicators.join(', ')}\n\nReturn ONLY the JSON array with valid stage names:`;\n  try {\n    var _data$choices, _data$choices$, _data$choices$$messag;\n    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Authorization': 'Bearer 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',\n        'Content-Type': 'application/json',\n        'HTTP-Referer': 'http://localhost:3000',\n        'X-Title': 'Advanced Attio CRM Intelligence'\n      },\n      body: JSON.stringify({\n        model: 'deepseek/deepseek-r1:free',\n        messages: [{\n          role: 'system',\n          content: 'You are an advanced CRM intelligence assistant. Extract comprehensive deal, relationship, and business intelligence from sales conversations. Always return valid JSON with detailed context and sentiment analysis. DO NOT create person objects for teams, roles, or departments - only for named individuals. Use only the valid stage names provided.'\n        }, {\n          role: 'user',\n          content: prompt\n        }],\n        temperature: 0.1,\n        max_tokens: 4000\n      })\n    });\n    const data = await response.json();\n    const raw = (_data$choices = data.choices) === null || _data$choices === void 0 ? void 0 : (_data$choices$ = _data$choices[0]) === null || _data$choices$ === void 0 ? void 0 : (_data$choices$$messag = _data$choices$.message) === null || _data$choices$$messag === void 0 ? void 0 : _data$choices$$messag.content;\n    if (!raw) {\n      console.warn('âŒ No response from Advanced DeepSeek');\n      return [];\n    }\n    console.log('ðŸ§  Advanced AI Response:', raw);\n\n    // Enhanced JSON extraction\n    let cleaned = raw.replace(/```json|```/g, '').trim();\n\n    // Find the JSON array more robustly\n    const jsonStart = cleaned.indexOf('[');\n    const jsonEnd = cleaned.lastIndexOf(']');\n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      cleaned = cleaned.substring(jsonStart, jsonEnd + 1);\n    }\n    console.log('ðŸ§¹ Cleaned Advanced Response:', cleaned);\n    const parsed = JSON.parse(cleaned);\n    if (!Array.isArray(parsed)) {\n      console.warn('âŒ Advanced response is not an array');\n      return [];\n    }\n\n    // Enhanced validation and enrichment\n    const enriched = await Promise.all(parsed.map(async item => {\n      // Skip team/role items that somehow got through\n      if (item.type === 'person' && isTeamOrRole(item.name)) {\n        console.log(`ðŸš« Filtering out team/role person: ${item.name}`);\n        return null;\n      }\n\n      // Add timestamps\n      item.created_at = new Date().toISOString();\n\n      // Enrich deal objects with analysis and stage validation\n      if (item.type === 'deal') {\n        if (item.stage) {\n          const validStage = await mapToValidStage(item.stage);\n          if (validStage) {\n            // Keep the stage as a string, don't assign the entire object\n            item.stage = validStage.title; // Use .title instead of the whole object\n            console.log(`âœ… Stage validated: \"${item.stage}\"`);\n          } else {\n            console.warn(`âš ï¸ Invalid stage: \"${item.stage}\" - removing`);\n            delete item.stage;\n          }\n        }\n\n        // Optional: Normalize missing deal owner\n        if (!item.owner) {\n          item.owner = null; // or leave undefined if Attio accepts null\n        }\n      }\n      return item;\n    }));\n    return enriched.filter(Boolean);\n  } catch (err) {\n    console.error('âŒ Error parsing advanced DeepSeek response:', err);\n    return [];\n  }\n}\nfunction parseSmartDate(dateStr) {\n  try {\n    const lower = dateStr.toLowerCase();\n    const currentYear = new Date().getFullYear();\n    if (lower.includes('q1')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 2, 31).toISOString(); // End of Q1\n    }\n    if (lower.includes('q2')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 5, 30).toISOString(); // End of Q2  \n    }\n    if (lower.includes('q3')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 8, 30).toISOString(); // End of Q3\n    }\n    if (lower.includes('q4')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 11, 31).toISOString(); // End of Q4\n    }\n\n    // Try direct parsing\n    return new Date(dateStr).toISOString();\n  } catch {\n    // Default to end of next quarter\n    const nextQuarter = new Date();\n    nextQuarter.setMonth(nextQuarter.getMonth() + 3);\n    return nextQuarter.toISOString();\n  }\n}\nfunction getSmartDueDate(taskType) {\n  const now = new Date();\n  switch (taskType) {\n    case 'follow_up':\n      now.setDate(now.getDate() + 2); // 2 days\n      break;\n    case 'demo':\n      now.setDate(now.getDate() + 7); // 1 week\n      break;\n    case 'proposal':\n      now.setDate(now.getDate() + 5); // 5 days\n      break;\n    case 'contract_review':\n      now.setDate(now.getDate() + 14); // 2 weeks\n      break;\n    default:\n      now.setDate(now.getDate() + 3);\n    // 3 days default\n  }\n  return now.toISOString();\n}\nfunction inferTaskPriority(task, dealAnalysis) {\n  // High priority for deals with strong buying signals\n  if (dealAnalysis.buying_signals.length > 0) return 'high';\n\n  // High priority for addressing risk signals\n  if (dealAnalysis.risk_signals.length > 0) return 'high';\n\n  // High priority task types\n  if (['demo', 'contract_review'].includes(task.task_type)) return 'high';\n\n  // Medium priority for follow-ups\n  if (task.task_type === 'follow_up') return 'medium';\n  return 'medium';\n}\n\n// Conversation context management\nexport class ConversationContext {\n  constructor() {\n    this.activeDeals = new Set();\n    this.knownContacts = new Set();\n    this.companies = new Set();\n    this.recentContext = [];\n  }\n  updateContext(extractedData) {\n    extractedData.forEach(item => {\n      if (item.type === 'deal') {\n        this.activeDeals.add(item.name);\n      }\n      if (item.type === 'person') {\n        this.knownContacts.add(item.name);\n      }\n      if (item.type === 'company') {\n        this.companies.add(item.name);\n      }\n    });\n\n    // Keep last 10 interactions for context\n    this.recentContext.push({\n      timestamp: new Date().toISOString(),\n      data: extractedData\n    });\n    if (this.recentContext.length > 10) {\n      this.recentContext.shift();\n    }\n  }\n  getContext() {\n    return {\n      activeDeals: Array.from(this.activeDeals).join(', '),\n      knownContacts: Array.from(this.knownContacts).join(', '),\n      companies: Array.from(this.companies).join(', ')\n    };\n  }\n}\nexport { parseSmartDate, getSmartDueDate, inferTaskPriority };","map":{"version":3,"names":["isTeamOrRole","analyzeDealLanguage","mapToValidStage","sendToAdvancedDeepSeek","text","conversationContext","dealAnalysis","prompt","activeDeals","knownContacts","company","stage","sentiment","buying_signals","join","risk_signals","value_indicators","_data$choices","_data$choices$","_data$choices$$messag","response","fetch","method","headers","body","JSON","stringify","model","messages","role","content","temperature","max_tokens","data","json","raw","choices","message","console","warn","log","cleaned","replace","trim","jsonStart","indexOf","jsonEnd","lastIndexOf","substring","parsed","parse","Array","isArray","enriched","Promise","all","map","item","type","name","created_at","Date","toISOString","validStage","title","owner","filter","Boolean","err","error","parseSmartDate","dateStr","lower","toLowerCase","currentYear","getFullYear","includes","year","nextQuarter","setMonth","getMonth","getSmartDueDate","taskType","now","setDate","getDate","inferTaskPriority","task","length","task_type","ConversationContext","constructor","Set","companies","recentContext","updateContext","extractedData","forEach","add","push","timestamp","shift","getContext","from"],"sources":["/Users/Aditya/ConversationalAI_CRM_Attio/src/advanced-parser.js"],"sourcesContent":["// advanced-parser.js - Enhanced AI parsing for deal intelligence\n\nimport { isTeamOrRole, analyzeDealLanguage, mapToValidStage } from './advanced-attio.js';\n\n\nexport async function sendToAdvancedDeepSeek(text, conversationContext = {}) {\n  const dealAnalysis = analyzeDealLanguage(text);\n  \n  const prompt = `\nYou are an advanced Attio CRM intelligence assistant. Extract structured data from sales conversations with sophisticated deal and relationship insights.\n\nCONTEXT:\n- Current conversation deals with: ${conversationContext.activeDeals || 'unknown deals'}\n- Known contacts: ${conversationContext.knownContacts || 'unknown contacts'}  \n- Company focus: ${conversationContext.company || 'unknown company'}\n\nCRITICAL EXTRACTION RULES:\n1. âŒ DO NOT create person objects for teams, roles, or departments:\n   - Skip: \"Engineering Team\", \"Legal Team\", \"Marketing Team\", \"CTO\", \"CEO\", \"VP Sales\"\n   - Instead: Add team/role info to individual person's notes or role field\n2. âœ… DO create person objects only for named individuals:\n   - \"Lisa from marketing\" âœ…\n   - \"Dave in procurement\" âœ…  \n   - \"Engineering Team\" âŒ\n3. ðŸ”„ For updating existing people, always include identifying info (email preferred)\n4. ðŸŽ¯ Use ONLY these valid deal stages (case sensitive):\n   - \"Qualified\", \"Discovery\", \"Demo\", \"Proposal\", \"Negotiation\", \"Closed Won\", \"Closed Lost\"\n5. ðŸ”— Link deals to companies and decision makers when possible\n6. ðŸ“‹ Create follow-up tasks for implied next steps\n7. ðŸ’¼ Support employee-employee CRM with internal stakeholder tracking\n\nIMPORTANT: Use these valid deal stages only:\n- \"Qualified\" (for initial contact, first calls)\n- \"Discovery\" (for requirement gathering, understanding needs)\n- \"Demo\" (for demonstrations, presentations)\n- \"Proposal\" (for quotes, pricing, proposals)\n- \"Negotiation\" (for contract terms, legal review)\n- \"Closed Won\" (for signed deals)\n- \"Closed Lost\" (for lost deals)\n\nRESPONSE FORMAT - Return valid JSON array with these object types:\n\nPERSON OBJECT:\n{\n  \"type\": \"person\",\n  \"name\": \"Full Name\",\n  \"first_name\": \"First\",\n  \"last_name\": \"Last\",\n  \"email\": \"email@domain.com\",\n  \"role\": \"CTO/CMO/etc\",\n  \"company\": \"Company Name\",\n  \"sentiment\": \"positive/negative/neutral\",\n  \"notes\": \"Context about this person's stance/concerns\"\n}\n\nCOMPANY OBJECT:\n{\n  \"type\": \"company\", \n  \"name\": \"Company Name\",\n  \"relationship_health\": \"high/medium/low\",\n  \"expansion_opportunity\": \"Description of expansion potential\",\n  \"churn_risk\": \"low/medium/high\"\n}\n\nDEAL OBJECT:\n{\n  \"type\": \"deal\",\n  \"name\": \"Deal Name\",\n  \"company\": \"Company Name\", \n  \"value\": 150000,\n  \"close_date\": \"Q1 2026\",\n  \"stage\": \"Proposal\",\n  \"probability\": 75,\n  \"competitors\": [\"Competitor 1\", \"Competitor 2\"],\n  \"pain_points\": [\"Integration concerns\", \"Budget constraints\"],\n  \"decision_maker\": \"Person Name\",\n  \"buying_signals\": [\"budget approved\", \"timeline established\"],\n  \"risk_signals\": [\"legal reviewing\", \"other priorities\"]\n}\n\nTASK OBJECT:\n{\n  \"type\": \"task\",\n  \"name\": \"Task Name\",\n  \"description\": \"Detailed task description\",\n  \"due_date\": \"2025-08-06T15:00:00Z\",\n  \"priority\": \"high/medium/low\",\n  \"link_to_person_name\": \"Person Name\",\n  \"link_to_company\": \"Company Name\", \n  \"link_to_deal\": \"Deal Name\",\n  \"task_type\": \"follow_up/demo/proposal/contract_review\"\n}\n\nRELATIONSHIP OBJECT:\n{\n  \"type\": \"relationship\",\n  \"company\": \"Company Name\",\n  \"contact_updates\": [\n    {\n      \"name\": \"Person Name\",\n      \"sentiment\": \"positive/negative\", \n      \"context\": \"Specific feedback or concerns\"\n    }\n  ],\n  \"account_health\": {\n    \"overall_score\": \"high/medium/low\",\n    \"expansion_notes\": \"Technical team interested in API features\",\n    \"risk_level\": \"Budget concerns from procurement\"\n  }\n}\n\nINTELLIGENCE EXTRACTION EXAMPLES:\n\nINPUT: \"So if I understand correctly, you've got budget approved for Q1 of next year, somewhere in the $150K range, but the real decision maker here is going to be your CTO because of the ERP integration concerns...\"\n\nOUTPUT:\n[\n  {\n    \"type\": \"deal\",\n    \"name\": \"Q1 2026 Deal\",\n    \"value\": 150000,\n    \"close_date\": \"Q1 2026\", \n    \"stage\": \"Proposal\",\n    \"probability\": 80,\n    \"pain_points\": [\"ERP integration concerns\"],\n    \"decision_maker\": \"CTO\",\n    \"buying_signals\": [\"budget approved\"]\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"CTO\",\n    \"first_name\": \"CTO\",\n    \"last_name\": \"\",\n    \"role\": \"CTO\", \n    \"sentiment\": \"neutral\",\n    \"notes\": \"Key decision maker, concerned about ERP integration\"\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Technical Demo for CTO\",\n    \"description\": \"Schedule technical demonstration focusing on ERP integration capabilities\",\n    \"due_date\": \"2025-08-14T15:00:00Z\",\n    \"priority\": \"high\",\n    \"link_to_person_name\": \"CTO\",\n    \"link_to_deal\": \"Q1 2026 Deal\",\n    \"task_type\": \"demo\"\n  }\n]\n\nINPUT: \"Things are going really well with the engineering team - they love the new API. But I'm a bit worried about the marketing team adoption. Lisa mentioned budget concerns for next year, and honestly, I think Dave from procurement is still skeptical about the ROI since that Q3 incident.\"\n\nOUTPUT:\n[\n  {\n    \"type\": \"company\",\n    \"name\": \"Current Client\",\n    \"relationship_health\": \"medium\",\n    \"expansion_opportunity\": \"Engineering team loves API - potential for expanded features\",\n    \"churn_risk\": \"medium\"\n  },\n  {\n    \"type\": \"person\", \n    \"name\": \"Engineering Team\",\n    \"first_name\": \"Engineering\",\n    \"last_name\": \"Team\",\n    \"role\": \"Engineering\",\n    \"sentiment\": \"positive\",\n    \"notes\": \"Loves the new API functionality\"\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"Lisa\",\n    \"first_name\": \"Lisa\",\n    \"last_name\": \"\",\n    \"role\": \"Marketing\",\n    \"sentiment\": \"negative\", \n    \"notes\": \"Has budget concerns for next year\"\n  },\n  {\n    \"type\": \"person\",\n    \"name\": \"Dave\",\n    \"first_name\": \"Dave\",\n    \"last_name\": \"\",\n    \"role\": \"Procurement\",\n    \"sentiment\": \"negative\",\n    \"notes\": \"Skeptical about ROI since Q3 incident\"\n  },\n  {\n    \"type\": \"relationship\",\n    \"company\": \"Current Client\",\n    \"contact_updates\": [\n      {\n        \"name\": \"Engineering Team\",\n        \"sentiment\": \"positive\",\n        \"context\": \"Loves new API\"\n      },\n      {\n        \"name\": \"Lisa\", \n        \"sentiment\": \"negative\",\n        \"context\": \"Budget concerns for next year\"\n      },\n      {\n        \"name\": \"Dave\",\n        \"sentiment\": \"negative\", \n        \"context\": \"Skeptical about ROI since Q3 incident\"\n      }\n    ],\n    \"account_health\": {\n      \"overall_score\": \"medium\",\n      \"expansion_notes\": \"API adoption going well with engineering\",\n      \"risk_level\": \"Budget and ROI concerns from marketing and procurement\"\n    }\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Address procurement ROI concerns with Dave\",\n    \"description\": \"Schedule meeting with Dave to address ROI skepticism stemming from Q3 incident\",\n    \"due_date\": \"2025-08-06T15:00:00Z\",\n    \"priority\": \"high\",\n    \"link_to_person_name\": \"Dave\", \n    \"link_to_company\": \"Current Client\",\n    \"task_type\": \"follow_up\"\n  },\n  {\n    \"type\": \"task\",\n    \"name\": \"Explore expanded API features with engineering\",\n    \"description\": \"Follow up with engineering team on additional API features they'd find valuable\",\n    \"due_date\": \"2025-08-08T15:00:00Z\", \n    \"priority\": \"medium\",\n    \"link_to_person_name\": \"Engineering Team\",\n    \"link_to_company\": \"Current Client\",\n    \"task_type\": \"follow_up\"\n  }\n]\n\nCONVERSATION TO ANALYZE:\n\"\"\"\n${text}\n\"\"\"\n\nDETECTED SIGNALS FROM PRE-ANALYSIS:\n- Stage: ${dealAnalysis.stage}\n- Sentiment: ${dealAnalysis.sentiment} \n- Buying Signals: ${dealAnalysis.buying_signals.join(', ')}\n- Risk Signals: ${dealAnalysis.risk_signals.join(', ')}\n- Value Indicators: ${dealAnalysis.value_indicators.join(', ')}\n\nReturn ONLY the JSON array with valid stage names:`;\n\n  try {\n    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Authorization': 'Bearer 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',\n        'Content-Type': 'application/json',\n        'HTTP-Referer': 'http://localhost:3000',\n        'X-Title': 'Advanced Attio CRM Intelligence'\n      },\n      body: JSON.stringify({\n        model: 'deepseek/deepseek-r1:free',\n        messages: [\n          {\n            role: 'system',\n            content: 'You are an advanced CRM intelligence assistant. Extract comprehensive deal, relationship, and business intelligence from sales conversations. Always return valid JSON with detailed context and sentiment analysis. DO NOT create person objects for teams, roles, or departments - only for named individuals. Use only the valid stage names provided.'\n          },\n          {\n            role: 'user',\n            content: prompt\n          }\n        ],\n        temperature: 0.1,\n        max_tokens: 4000\n      })\n    });\n\n    const data = await response.json();\n    const raw = data.choices?.[0]?.message?.content;\n    \n    if (!raw) {\n      console.warn('âŒ No response from Advanced DeepSeek');\n      return [];\n    }\n\n    console.log('ðŸ§  Advanced AI Response:', raw);\n\n    // Enhanced JSON extraction\n    let cleaned = raw.replace(/```json|```/g, '').trim();\n    \n    // Find the JSON array more robustly\n    const jsonStart = cleaned.indexOf('[');\n    const jsonEnd = cleaned.lastIndexOf(']');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      cleaned = cleaned.substring(jsonStart, jsonEnd + 1);\n    }\n\n    console.log('ðŸ§¹ Cleaned Advanced Response:', cleaned);\n\n    const parsed = JSON.parse(cleaned);\n\n    if (!Array.isArray(parsed)) {\n      console.warn('âŒ Advanced response is not an array');\n      return [];\n    }\n\n    // Enhanced validation and enrichment\n    const enriched = await Promise.all(parsed.map(async (item) => {\n      // Skip team/role items that somehow got through\n      if (item.type === 'person' && isTeamOrRole(item.name)) {\n        console.log(`ðŸš« Filtering out team/role person: ${item.name}`);\n        return null;\n      }\n\n      // Add timestamps\n      item.created_at = new Date().toISOString();\n\n      // Enrich deal objects with analysis and stage validation\n      if (item.type === 'deal') {\n        if (item.stage) {\n          const validStage = await mapToValidStage(item.stage);\n          if (validStage) {\n            // Keep the stage as a string, don't assign the entire object\n            item.stage = validStage.title; // Use .title instead of the whole object\n            console.log(`âœ… Stage validated: \"${item.stage}\"`);\n          } else {\n            console.warn(`âš ï¸ Invalid stage: \"${item.stage}\" - removing`);\n            delete item.stage;\n          }\n        }\n\n        // Optional: Normalize missing deal owner\n        if (!item.owner) {\n          item.owner = null; // or leave undefined if Attio accepts null\n        }\n      }\n\n      return item;\n    }));\n\n    return enriched.filter(Boolean);\n  } catch (err) {\n    console.error('âŒ Error parsing advanced DeepSeek response:', err);\n    return [];\n  }\n}\n\nfunction parseSmartDate(dateStr) {\n  try {\n    const lower = dateStr.toLowerCase();\n    const currentYear = new Date().getFullYear();\n    \n    if (lower.includes('q1')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 2, 31).toISOString(); // End of Q1\n    }\n    if (lower.includes('q2')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 5, 30).toISOString(); // End of Q2  \n    }\n    if (lower.includes('q3')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 8, 30).toISOString(); // End of Q3\n    }\n    if (lower.includes('q4')) {\n      const year = lower.includes('next year') ? currentYear + 1 : currentYear;\n      return new Date(year, 11, 31).toISOString(); // End of Q4\n    }\n    \n    // Try direct parsing\n    return new Date(dateStr).toISOString();\n  } catch {\n    // Default to end of next quarter\n    const nextQuarter = new Date();\n    nextQuarter.setMonth(nextQuarter.getMonth() + 3);\n    return nextQuarter.toISOString();\n  }\n}\n\nfunction getSmartDueDate(taskType) {\n  const now = new Date();\n  \n  switch (taskType) {\n    case 'follow_up':\n      now.setDate(now.getDate() + 2); // 2 days\n      break;\n    case 'demo':\n      now.setDate(now.getDate() + 7); // 1 week\n      break;\n    case 'proposal':\n      now.setDate(now.getDate() + 5); // 5 days\n      break;\n    case 'contract_review':\n      now.setDate(now.getDate() + 14); // 2 weeks\n      break;\n    default:\n      now.setDate(now.getDate() + 3); // 3 days default\n  }\n  \n  return now.toISOString();\n}\n\nfunction inferTaskPriority(task, dealAnalysis) {\n  // High priority for deals with strong buying signals\n  if (dealAnalysis.buying_signals.length > 0) return 'high';\n  \n  // High priority for addressing risk signals\n  if (dealAnalysis.risk_signals.length > 0) return 'high';\n  \n  // High priority task types\n  if (['demo', 'contract_review'].includes(task.task_type)) return 'high';\n  \n  // Medium priority for follow-ups\n  if (task.task_type === 'follow_up') return 'medium';\n  \n  return 'medium';\n}\n\n// Conversation context management\nexport class ConversationContext {\n  constructor() {\n    this.activeDeals = new Set();\n    this.knownContacts = new Set();\n    this.companies = new Set();\n    this.recentContext = [];\n  }\n  \n  updateContext(extractedData) {\n    extractedData.forEach(item => {\n      if (item.type === 'deal') {\n        this.activeDeals.add(item.name);\n      }\n      if (item.type === 'person') {\n        this.knownContacts.add(item.name);\n      }\n      if (item.type === 'company') {\n        this.companies.add(item.name);\n      }\n    });\n    \n    // Keep last 10 interactions for context\n    this.recentContext.push({\n      timestamp: new Date().toISOString(),\n      data: extractedData\n    });\n    \n    if (this.recentContext.length > 10) {\n      this.recentContext.shift();\n    }\n  }\n  \n  getContext() {\n    return {\n      activeDeals: Array.from(this.activeDeals).join(', '),\n      knownContacts: Array.from(this.knownContacts).join(', '),\n      companies: Array.from(this.companies).join(', ')\n    };\n  }\n}\n\nexport { parseSmartDate, getSmartDueDate, inferTaskPriority };"],"mappings":"AAAA;;AAEA,SAASA,YAAY,EAAEC,mBAAmB,EAAEC,eAAe,QAAQ,qBAAqB;AAGxF,OAAO,eAAeC,sBAAsBA,CAACC,IAAI,EAAEC,mBAAmB,GAAG,CAAC,CAAC,EAAE;EAC3E,MAAMC,YAAY,GAAGL,mBAAmB,CAACG,IAAI,CAAC;EAE9C,MAAMG,MAAM,GAAG;AACjB;AACA;AACA;AACA,qCAAqCF,mBAAmB,CAACG,WAAW,IAAI,eAAe;AACvF,oBAAoBH,mBAAmB,CAACI,aAAa,IAAI,kBAAkB;AAC3E,mBAAmBJ,mBAAmB,CAACK,OAAO,IAAI,iBAAiB;AACnE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}